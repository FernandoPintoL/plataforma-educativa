# üõçÔ∏è FLUJO DE TRABAJO - M√ìDULO DE VENTAS

## üìã √çNDICE

1. [Arquitectura General](#arquitectura-general)
2. [Flujo de Datos](#flujo-de-datos)
3. [Casos de Uso](#casos-de-uso)
4. [APIs y Endpoints](#apis-y-endpoints)
5. [Frontend Components](#frontend-components)
6. [Automatizaciones](#automatizaciones)
7. [Flujo Completo Paso a Paso](#flujo-completo-paso-a-paso)

---

## üèóÔ∏è ARQUITECTURA GENERAL

### Estructura del M√≥dulo

```
app/
‚îú‚îÄ‚îÄ Http/Controllers/
‚îÇ   ‚îú‚îÄ‚îÄ VentaController.php              # Controlador principal
‚îÇ   ‚îî‚îÄ‚îÄ DetalleVentaController.php       # Gesti√≥n de detalles
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ Venta.php                        # Modelo principal con eventos
‚îÇ   ‚îú‚îÄ‚îÄ DetalleVenta.php                 # Detalles de productos
‚îÇ   ‚îú‚îÄ‚îÄ Cliente.php                      # Relaci√≥n con clientes
‚îÇ   ‚îú‚îÄ‚îÄ EstadoDocumento.php              # Estados de venta
‚îÇ   ‚îî‚îÄ‚îÄ Moneda.php                       # Monedas disponibles
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îî‚îÄ‚îÄ StockService.php                 # Gesti√≥n autom√°tica de stock
‚îú‚îÄ‚îÄ Http/Requests/
‚îÇ   ‚îú‚îÄ‚îÄ StoreVentaRequest.php            # Validaci√≥n creaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ UpdateVentaRequest.php           # Validaci√≥n actualizaci√≥n
‚îî‚îÄ‚îÄ Observers/
    ‚îî‚îÄ‚îÄ VentaObserver.php                # Eventos automatizados
```

```
resources/js/
‚îú‚îÄ‚îÄ Pages/ventas/
‚îÇ   ‚îú‚îÄ‚îÄ index.tsx                        # Lista de ventas
‚îÇ   ‚îú‚îÄ‚îÄ create.tsx                       # Formulario creaci√≥n/edici√≥n
‚îÇ   ‚îî‚îÄ‚îÄ show.tsx                         # Vista detallada
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ VentaPreviewModal.tsx            # Modal vista previa
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îî‚îÄ‚îÄ ventas.ts                        # Tipos TypeScript
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ ventas.service.ts                # Servicio frontend
```

---

## üîÑ FLUJO DE DATOS

### 1. **Entrada de Datos**

```
Usuario ‚Üí Formulario ‚Üí Validaci√≥n ‚Üí Controlador ‚Üí Modelo
```

### 2. **Procesamiento**

```
Modelo ‚Üí Eventos ‚Üí Automatizaciones ‚Üí Base de Datos
```

### 3. **Respuesta**

```
Base de Datos ‚Üí Controlador ‚Üí JSON/Inertia ‚Üí Frontend ‚Üí Usuario
```

---

## üéØ CASOS DE USO

### üìù **UC01: Crear Nueva Venta**

**Actor:** Usuario autorizado
**Flujo Principal:**

1. Usuario accede a `/ventas/create`
2. Selecciona cliente y datos b√°sicos
3. Agrega productos con cantidades
4. Sistema valida stock en tiempo real
5. Usuario revisa en modal de vista previa
6. Confirma creaci√≥n
7. Sistema procesa automatizaciones

### üëÄ **UC02: Ver Lista de Ventas**

**Actor:** Usuario autorizado
**Flujo Principal:**

1. Usuario accede a `/ventas`
2. Sistema muestra lista paginada
3. Usuario puede filtrar y buscar
4. Acceso a acciones individuales

### üîç **UC03: Ver Detalle de Venta**

**Actor:** Usuario autorizado
**Flujo Principal:**

1. Usuario selecciona venta desde lista
2. Sistema muestra informaci√≥n completa
3. Hist√≥rico de pagos y movimientos
4. Enlaces a documentos relacionados

### ‚úèÔ∏è **UC04: Editar Venta**

**Actor:** Usuario autorizado
**Flujo Principal:**

1. Usuario selecciona editar venta
2. Sistema carga datos existentes
3. Usuario modifica informaci√≥n
4. Sistema actualiza con validaciones
5. Automatizaciones se reajustan

### üóëÔ∏è **UC05: Eliminar Venta**

**Actor:** Usuario autorizado
**Flujo Principal:**

1. Usuario confirma eliminaci√≥n
2. Sistema revierte movimientos
3. Elimina registros relacionados
4. Confirma operaci√≥n

---

## üîå APIS Y ENDPOINTS

### **Rutas Web (Inertia.js)**

```php
// CRUD B√°sico
GET    /ventas              # Lista de ventas
GET    /ventas/create       # Formulario creaci√≥n
POST   /ventas              # Crear venta
GET    /ventas/{id}         # Ver detalle
GET    /ventas/{id}/edit    # Formulario edici√≥n
PUT    /ventas/{id}         # Actualizar
DELETE /ventas/{id}         # Eliminar

// Funcionalidades Especiales
GET    /ventas/stock/{producto}  # Verificar stock
```

### **Rutas API (JSON)**

```php
// Mismas rutas con header Accept: application/json
POST   /api/ventas/verificar-stock     # Validaci√≥n stock m√∫ltiple
GET    /api/ventas/{id}/resumen-stock  # Resumen stock venta
GET    /api/ventas/productos-stock-bajo # Productos con stock bajo
```

### **Endpoints del Controlador**

#### `VentaController::index()`

- **Entrada:** Par√°metros de filtro opcionales
- **Salida:** Lista paginada de ventas con relaciones
- **Formato:** Inertia render o JSON

#### `VentaController::create()`

- **Entrada:** Ninguna
- **Salida:** Formulario con datos precargados
- **Datos incluidos:** Clientes, Productos, Monedas, Estados

#### `VentaController::store(StoreVentaRequest)`

- **Entrada:** Datos validados de venta
- **Procesamiento:** Transacci√≥n completa con automatizaciones
- **Salida:** Venta creada con confirmaci√≥n

#### `VentaController::show($id)`

- **Entrada:** ID de venta
- **Salida:** Venta completa con relaciones
- **Incluye:** Detalles, Cliente, Pagos, Cuenta por Cobrar

#### `VentaController::verificarStock(Request)`

- **Entrada:** Array de productos y cantidades
- **Procesamiento:** Validaci√≥n usando StockService
- **Salida:** Estado de validaci√≥n y detalles

---

## ‚öõÔ∏è FRONTEND COMPONENTS

### **P√°ginas Principales**

#### `ventas/index.tsx`

- **Prop√≥sito:** Lista principal de ventas
- **Caracter√≠sticas:**
  - Tabla responsive con paginaci√≥n
  - Filtros por fecha, cliente, estado
  - Acciones: Ver, Editar, Eliminar
  - Links a creaci√≥n

#### `ventas/create.tsx`

- **Prop√≥sito:** Formulario creaci√≥n/edici√≥n
- **Caracter√≠sticas:**
  - Validaci√≥n en tiempo real
  - B√∫squeda din√°mica de productos
  - C√°lculo autom√°tico de totales
  - Vista previa antes de confirmar
  - Estado defensivo para props undefined

#### `ventas/show.tsx`

- **Prop√≥sito:** Vista detallada de venta
- **Caracter√≠sticas:**
  - Informaci√≥n completa
  - Hist√≥rico de movimientos
  - Enlaces a documentos
  - Acciones contextuales

### **Componentes Reutilizables**

#### `VentaPreviewModal.tsx`

- **Prop√≥sito:** Modal de confirmaci√≥n
- **Caracter√≠sticas:**
  - Vista completa de datos
  - Dise√±o responsive
  - Soporte tema claro/oscuro
  - Animaciones suaves

---

## ü§ñ AUTOMATIZACIONES

### **Event Listeners en Modelo Venta**

#### `created` Event

```php
static::created(function ($venta) {
    $venta->procesarMovimientosStock();    // Reduce stock autom√°ticamente
    $venta->generarAsientoContable();      // Crea asiento contable
    $venta->generarMovimientoCaja();       // Registra en caja
});
```

#### `deleting` Event

```php
static::deleting(function ($venta) {
    $venta->revertirMovimientosStock();    // Devuelve stock
    $venta->eliminarAsientoContable();     // Elimina asiento
});
```

### **StockService Automatizaciones**

#### Validaci√≥n FIFO

```php
public function validarStockDisponible($productos, $almacenId = null)
{
    // Valida disponibilidad con l√≥gica FIFO
    // Retorna errores espec√≠ficos por producto
}
```

#### Procesamiento de Salida

```php
public function procesarSalidaVenta($ventaId)
{
    // Procesa salidas por lotes FIFO
    // Actualiza stock autom√°ticamente
}
```

---

## üöÄ FLUJO COMPLETO PASO A PASO

### **1. INICIO DE VENTA**

```mermaid
graph TD
    A[Usuario accede /ventas/create] --> B[Sistema carga dependencias]
    B --> C[Clientes, Productos, Monedas, Estados]
    C --> D[Renderiza formulario]
    D --> E[Genera n√∫mero autom√°tico]
```

**C√≥digo involucrado:**

- `VentaController::create()`
- `resources/js/Pages/ventas/create.tsx`
- Props: clientes, productos, monedas, estados_documento

### **2. SELECCI√ìN DE DATOS**

```mermaid
graph TD
    A[Usuario selecciona cliente] --> B[Usuario busca productos]
    B --> C[Autocompletado con c√≥digos]
    C --> D[Agrega producto a detalles]
    D --> E[Validaci√≥n stock tiempo real]
    E --> F[C√°lculo autom√°tico totales]
```

**Funciones clave:**

- `addProductToDetail()`
- `updateDetail()`
- `calculateTotals()`

### **3. VALIDACI√ìN PREVIA**

```mermaid
graph TD
    A[Usuario completa formulario] --> B[Click en Crear venta]
    B --> C[Validaci√≥n frontend async]
    C --> D{¬øDatos v√°lidos?}
    D -->|No| E[Mostrar errores]
    D -->|S√≠| F[Abrir modal preview]
```

**Validaciones:**

- `ventasService.validateData(data)`
- Campos obligatorios
- Productos m√≠nimos
- Stock disponible

### **4. VISTA PREVIA**

```mermaid
graph TD
    A[Modal preview abierto] --> B[Muestra todos los datos]
    B --> C[Usuario revisa informaci√≥n]
    C --> D{¬øConfirma?}
    D -->|No| E[Vuelve a editar]
    D -->|S√≠| F[Procesa venta]
```

**Componente:** `VentaPreviewModal.tsx`
**Datos mostrados:**

- Informaci√≥n documento
- Datos cliente
- Lista productos
- Resumen totales

### **5. PROCESAMIENTO BACKEND**

```mermaid
graph TD
    A[Recibe datos validados] --> B[Inicia transacci√≥n DB]
    B --> C[Valida stock StockService]
    C --> D{¬øStock suficiente?}
    D -->|No| E[Error + Rollback]
    D -->|S√≠| F[Crea registro Venta]
    F --> G[Crea detalles]
    G --> H[Trigger eventos modelo]
```

**Controller:** `VentaController::store()`
**Flujo transaccional completo**

### **6. AUTOMATIZACIONES**

```mermaid
graph TD
    A[Evento created disparado] --> B[procesarMovimientosStock]
    B --> C[Reduce stock por FIFO]
    C --> D[generarAsientoContable]
    D --> E[Crea asiento autom√°tico]
    E --> F[generarMovimientoCaja]
    F --> G[Registra movimiento caja]
```

**Servicios involucrados:**

- `StockService::procesarSalidaVenta()`
- `AsientoContableService`
- `CajaService`

### **7. RESPUESTA Y CONFIRMACI√ìN**

```mermaid
graph TD
    A[Automatizaciones completadas] --> B[Commit transacci√≥n]
    B --> C[Respuesta exitosa]
    C --> D{¬øEs API?}
    D -->|S√≠| E[Retorna JSON]
    D -->|No| F[Redirect con mensaje]
    F --> G[Lista ventas actualizada]
```

**Confirmaciones:**

- Toast notification
- Redirect a `/ventas`
- Informaci√≥n stock actualizada

---

## üìä ESTADOS Y TRANSICIONES

### **Estados de Venta**

- **BORRADOR**: Venta en construcci√≥n
- **CONFIRMADA**: Venta procesada
- **PAGADA**: Pagos completados
- **CANCELADA**: Venta anulada

### **Flujo de Estados**

```
BORRADOR ‚Üí CONFIRMADA ‚Üí PAGADA
    ‚Üì           ‚Üì
CANCELADA ‚Üê CANCELADA
```

---

## üîê SEGURIDAD Y PERMISOS

### **Permisos Requeridos**

```php
// Middleware en VentaController
'permission:ventas.index'     // Ver lista
'permission:ventas.create'    // Crear nueva
'permission:ventas.store'     // Guardar
'permission:ventas.show'      // Ver detalle
'permission:ventas.edit'      // Editar
'permission:ventas.update'    // Actualizar
'permission:ventas.destroy'   // Eliminar
'permission:ventas.verificar-stock' // Verificar stock
```

### **Validaciones de Seguridad**

- CSRF tokens autom√°ticos
- Validaci√≥n de permisos por ruta
- Sanitizaci√≥n de inputs
- Validaci√≥n de relaciones (cliente existe, etc.)

---

## üß™ TESTING

### **Tests Unitarios**

- Modelo Venta events
- StockService l√≥gica FIFO
- Validaciones de requests

### **Tests de Integraci√≥n**

- Flujo completo creaci√≥n venta
- Automatizaciones correctas
- Rollback en errores

### **Tests Frontend**

- Validaci√≥n formularios
- Modal preview
- C√°lculos autom√°ticos

---

## üìà M√âTRICAS Y MONITOREO

### **Logs Autom√°ticos**

- Creaci√≥n de ventas
- Errores de stock
- Automatizaciones fallidas

### **M√©tricas de Performance**

- Tiempo respuesta crear venta
- Validaciones de stock
- Carga de dependencias

---

## üîß CONFIGURACI√ìN

### **Variables Importantes**

```env
# Configuraci√≥n de ventas
STOCK_VALIDATION_ENABLED=true
CONTABILIDAD_AUTO=true
CAJA_AUTO=true
```

### **Configuraci√≥n Frontend**

```typescript
// ventas.service.ts
const API_BASE = '/ventas';
const VALIDATION_TIMEOUT = 5000;
```

---

## üìù CHANGELOG Y VERSIONES

### **v1.3.0 - Actual**

- ‚úÖ Modal de vista previa implementado
- ‚úÖ Validaci√≥n defensiva props undefined
- ‚úÖ Automatizaciones stock/contabilidad/caja
- ‚úÖ TypeScript completo

### **Pr√≥ximas Mejoras**

- üöß Facturaci√≥n electr√≥nica SIN
- üöß Sistema de auditor√≠a completo
- üöß Reportes avanzados de ventas

---

**Documentaci√≥n generada:** ${new Date().toLocaleDateString('es-BO')}
**Sistema:** Distribuidora Paucara - M√≥dulo Ventas
**Estado:** ‚úÖ Funcional al 95% - Modal implementado exitosamente
